---
- hosts: default
  become: true
  gather_facts: true
  vars:
    dev_uri: "https://developers.redhat.com/content-gateway/file/pub/openshift-v4/clients"
    mirror_uri: "https://mirror.openshift.com/pub/openshift-v4/x86_64/clients"
    ocp_ver: "4.11"
    quay_root: /opt/quay

  tasks:

    - name: Clean dnf cache
      shell: dnf clean all
    
    # TODO: Commented out for testing
    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
    
    - name: Install required packages
      ansible.builtin.dnf:
        name:
          - podman
          - firewalld
          - git
          - vim
          - python3
          - jq
    
    - name: Enable firewalld service
      ansible.builtin.systemd:
        name: firewalld
        state: started
        enabled: true
    
    - name: Update pip
      ansible.builtin.pip:
        name: pip
        state: latest
        executable: pip3
    
    # TODO: Add hardening 
    #ansible-playbook /tmp/harden_quay.yaml
    
    - name: Pull OCP Dependencies
      ansible.builtin.unarchive:
        src: "{{ item }}"
        dest: /usr/local/bin
      loop:
        - "{{ dev_uri }}/mirror-registry/1.2.6/mirror-registry.tar.gz"
        - "{{ mirror_uri }}/ocp/latest-${OCP_VER}/openshift-install-linux.tar.gz"
        - "{{ mirror_uri }}/ocp/latest-${OCP_VER}/openshift-client-linux.tar.gz"
        - "{{ mirror_uri }}/ocp/latest-${OCP_VER}/oc-mirror.tar.gz"
        - "{{ mirror_uri }}/pipeline/latest/tkn-linux-amd64.tar.gz"
    
    - name: Download odo
      ansible.builtin.get_url:
        url: "{{ item }}"
        dest: /usr/local/bin/odo
        mode: '0755'
      loop:
        - "{{ dev_uri }}/odo/v2.5.1/odo-linux-amd64"
    
    - name: Change file ownership, group and permissions
      ansible.builtin.file:
        path: "{{ item }}"
        owner: root
        group: root
        mode: 0755
      loop:
        - openshift-install
        - oc
        - kubectl
        - oc-mirror
        - tkn
        - tkn-pac
        - odo
        - mirror-registry
    
    - name: Restore SELinux context
      ansible.builtin.command: restorecon -v /usr/local/bin/{{ item }}
      loop:
        - openshift-install
        - oc
        - kubectl
        - oc-mirror
        - tkn
        - tkn-pac
        - odo
        - mirror-registry
    
    - name: Create quay directory
      file:
        path: "{{ quay_root }}"
        state: directory
    
    # Mirror registry setup
    ./mirror-registry install --verbose --quayRoot /opt/quay/ | tee mirror-registry.log
    
    - name: Remove existing quay certs from system trust store
      file:
        path: /etc/pki/ca-trust/source/anchors/quay.cert
        state: absent
    
    - name: Copy quay cert to system trust store
      copy:
        src: /opt/quay/quay-config/ssl.cert
        dest: /etc/pki/ca-trust/source/anchors/quay.cert
        remote_src: true
        owner: root
        group: root
        mode: 0644
    
    - name: Update system trust store
      ansible.builtin.command: update-ca-trust
    
    - name: Extract system trust store
      ansible.builtin.command: update-ca-trust extract
    
    #- name: Cleanup files
    #  file:
    #    path: "{{ item }}"
    #    state: absent
    #  loop:
    #    - README.md
    #    - LICENSE
    #    - execution-environment.tar
    #    - image-archive.tar
    #    - pause.tar
    #    - postgres.tar
    #    - quay.tar
    #    - redis.tar
